FROM ubuntu:quantal

# Get java, git and gradle

RUN echo "deb http://dk.archive.ubuntu.com/ubuntu/ precise-security main universe multiverse" >> /etc/apt/sources.list
RUN apt-get install -y software-properties-common
RUN add-apt-repository ppa:webupd8team/java
RUN add-apt-repository ppa:cwchien/gradle
RUN echo debconf shared/accepted-oracle-license-v1-1 select true | debconf-set-selections
RUN echo debconf shared/accepted-oracle-license-v1-1 seen true | debconf-set-selections
RUN apt-get update
RUN apt-get install -y --force-yes oracle-java7-installer vim
RUN apt-get install -y --force-yes git
RUN apt-get install -y gradle-1.9

# Get xorg and and vnc

RUN apt-get install -y xorg xvfb x11vnc ratpoison

# Get packages needed to run Android

RUN dpkg --add-architecture i386
RUN apt-get update
RUN apt-get install -y libc6:i386 libncurses5:i386 libstdc++6:i386 zlib1g:i386 
RUN dpkg-divert --local --rename --add /sbin/initctl
RUN ln -s /bin/true /sbin/initctl
RUN apt-get install -y libsdl1.2debian:i386
RUN apt-get install -y libswt-gtk-3-java

# Get android libs and setup targets

RUN wget http://dl.google.com/android/android-sdk_r22.3-linux.tgz && tar -xf /android-sdk_r22.3-linux.tgz
RUN (while true; do echo 'y'; sleep 2; done) | /android-sdk-linux/tools/android update sdk -u --filter extra-google-m2repository,extra-google-google_play_services,extra-android-support,android-18,platform-tools,tools,extra-android-m2repository,build-tools-19.0.1,sysimg-18

# Setup android emulator, start it so it saves a snapshot for quicker booting next time.

RUN (while true; do echo 'no'; sleep 2; done) | ANDROID_HOME=/android-sdk-linux ANDROID_SDK_HOME=/android-sdk-linux /android-sdk-linux/tools/android create avd -n testy -t 1 --snapshot --abi x86 --force
RUN sed -i 's/240/120/g' /android-sdk-linux/.android/avd/testy.avd/config.ini

RUN ANDROID_SDK_HOME=/android-sdk-linux /android-sdk-linux/tools/emulator-x86 @testy -no-window & /android-sdk-linux/platform-tools/adb wait-for-device \
&& while [ ! `/android-sdk-linux/platform-tools/adb shell getprop init.svc.bootanim | grep stopped` ]; do /android-sdk-linux/platform-tools/adb shell getprop init.svc.bootanim; done \
&& /android-sdk-linux/platform-tools/adb start-server \
&& echo avd snapshot save default-boot | nc -w 2 localhost 5554 && echo kill | nc -w 2 localhost 5554

# So we pull down the robotium Android downloads

RUN git clone https://github.com/denevell/Natch-Android.git
RUN cd Natch-Android/ && git pull origin master 
RUN cd Natch-Android/ && ANDROID_HOME=/android-sdk-linux/ gradle unitTest
